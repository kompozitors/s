/*
FunPay Lite Bot
Copyright (c) 2022-2025 Leonid Tsaruk aka NightStranger
Source o.js
Build 346a8139-3827-4b6b-a715-7c02d91f725e
*/
(()=>{function I(e,r=!1){let t=new Date,o=t.getDate().toString(),l=(t.getMonth()+1).toString(),s=t.getFullYear().toString(),c=t.getHours().toString(),a=t.getMinutes().toString(),n=t.getSeconds().toString();o.toString().length==1&&(o=`0${o}`),l.toString().length==1&&(l=`0${l}`),c.toString().length==1&&(c=`0${c}`),a.toString().length==1&&(a=`0${a}`),n.toString().length==1&&(n=`0${n}`);let p=`>[${o}.${l}.${s}] [${c}:${a}:${n}] >LB: ${e}`;r?console.error(p):console.log(p),typeof e=="object"&&console.log(e)}var S=I;function L(e){let r=/\d+/,t=Number(e.match(r));return isNaN(t)||t==0?null:t}var x=L;function O(e){try{let o=new DOMParser().parseFromString(e,"text/html").querySelectorAll(".promo-game-item"),l=[];for(let s=0;s<o.length;s++)try{let c=o[s],a=c.querySelector(".game-title a"),n=c.querySelectorAll("ul.list-inline"),p=a.innerHTML;for(let d=0;d<n.length;d++){let i=n[d],m=Number(i.dataset.id),u=i.querySelectorAll("li a");for(let h=0;h<u.length;h++){let f=u[h],g="Unknown";f.href.includes("lots")&&(g="lots"),f.href.includes("chips")&&(g="chips");let y=x(f.href),b=f.innerHTML;l.push({game_name:p,node_name:b,node_id:y,game_id:m,type:g})}}}catch(c){S(`Error while getting category: ${c}`)}return l}catch(r){return S("Error in parseAllFunPayCategories:"),S(r),null}}var T=O;function k(e){try{let r=[],l=new DOMParser().parseFromString(e,"text/html").querySelectorAll(".offer-list-title a");for(let s=0;s<l.length;s++){let a=l[s].href;if(a.includes("chips"))continue;let n=x(a);n&&r.push(n)}return r}catch(r){return console.log("Error in parseAllUserCategories:"),console.log(r),null}}var D=k;function q(){return"funpay.com"}var P=q;function B(){return`https://${P()}`}var M=B;function W(e){try{let r=M();return new DOMParser().parseFromString(e,"text/html").querySelector(`a[href="${r}/account/linkTelegram"]`)?.parentElement?.querySelector("b")?.textContent}catch(r){return console.log("Error in parseAllUserCategories:"),console.log(r),null}}var $=W;function N(e){let r=window.LBSalesMonths;function t(){let i=Math.floor(Date.now()/1e3),m=3*3600;return i+m}let o=t(),l=new Date(o*1e3),s=l.getUTCFullYear(),c=l.getUTCMonth(),a=l.getUTCDate();if(e.startsWith("сегодня")){let[,i]=e.split(", "),[m,u]=i.split(":").map(Number);return Date.UTC(s,c,a,m,u)-3*36e5}if(e.startsWith("вчера")){let[,i]=e.split(", "),[m,u]=i.split(":").map(Number);return Date.UTC(s,c,a-1,m,u)-3*36e5}let n=/^(\d{1,2}) ([а-я]+) (\d{4}), (\d{1,2}):(\d{2})$/i,p=/^(\d{1,2}) ([а-я]+), (\d{1,2}):(\d{2})$/i,d=e.match(n);if(d){let[,i,m,u,h,f]=d,g=r.indexOf(m.toLowerCase());if(g===-1)throw new Error("Некорректное название месяца: "+m);return Date.UTC(Number(u),g,Number(i),Number(h),Number(f))-3*36e5}if(d=e.match(p),d){let[,i,m,u,h]=d,f=r.indexOf(m.toLowerCase());if(f===-1)throw new Error("Некорректное название месяца: "+m);let g=s;return Date.UTC(g,f,Number(i),Number(u),Number(h))-3*36e5}throw new Error("Некорректный формат даты: "+e)}function E(e){try{let t=new DOMParser().parseFromString(e,"text/html"),o=t.querySelector("input[type='hidden'][name='continue']"),l=o?o.value:null,s=t.querySelectorAll("a.tc-item");if(!s||s.length===0)return{nextOrderId:null,orders:[]};let c=[];for(let a=0;a<s.length;a++)try{let n=s[a],p=n.classList,d;p.contains("warning")?d="refunded":p.contains("info")?d="paid":d="closed";let i=n.querySelector(".tc-order")?.textContent?.substring(1);if(!i)continue;let m=n.querySelector(".order-desc div")?.textContent,u=n.querySelector(".tc-price")?.textContent,h=u.replace(/\s/g,""),f=parseFloat(h),g;u.includes("₽")?g="RUB":u.includes("$")?g="USD":u.includes("€")?g="EUR":g="UNKNOWN";let y=n.querySelector(".media-user-name span"),b=y?.textContent||"",w=y?.getAttribute("data-href")?.split("/"),C=0;w&&(C=parseInt(w[w.length-2]||"0",10));let A=n.querySelector(".text-muted")?.textContent,U=n.querySelector(".tc-date-time")?.textContent,F=N(U);c.push({orderId:i,description:m||"",subcategoryName:A||"",price:f,currency:g,buyerUsername:b,buyerId:C,orderStatus:d,orderDate:F,orderDateText:U})}catch(n){console.log("Error in parseSales loop:"),console.log(n),console.log(s[a])}return{nextOrderId:l,orders:c}}catch(r){return console.log("Error in parseSales:"),console.log(r),null}}_();chrome.runtime.onMessage.addListener(async(e,r,t)=>await Y(e,r,t));async function Y(e,r,t){if(e.target==="offscreen"){if(e.method=="parseAllFunPayCategories"){let o=T(e.payload.html);t(o)}if(e.method=="parseAllUserCategories"){let o=D(e.payload.html);t(o)}if(e.method=="pTg"){let o=$(e.payload.html);t(o)}if(e.method=="parseSales"){let o=E(e.payload.html);t(o)}}}async function _(){let e=await chrome.runtime.sendMessage({target:"background",method:"getLocalizedMonths"});window.LBSalesMonths=e}})();
