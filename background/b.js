/*
FunPay Lite Bot
Copyright (c) 2022-2025 Leonid Tsaruk aka NightStranger
Source b.js
Build 346a8139-3827-4b6b-a715-7c02d91f725e
*/
(()=>{async function Se(e,t){chrome.runtime.getPlatformInfo(),t({farewell:!0})}var R=Se;async function xe(e,t){t({farewell:!0})}var V=xe;async function $e(e,t){chrome.runtime.reload(),t({farewell:!0})}var j=$e;function Ue(e,t=!1){let r=new Date,a=r.getDate().toString(),n=(r.getMonth()+1).toString(),s=r.getFullYear().toString(),o=r.getHours().toString(),l=r.getMinutes().toString(),i=r.getSeconds().toString();a.toString().length==1&&(a=`0${a}`),n.toString().length==1&&(n=`0${n}`),o.toString().length==1&&(o=`0${o}`),l.toString().length==1&&(l=`0${l}`),i.toString().length==1&&(i=`0${i}`);let g=`>[${a}.${n}.${s}] [${o}:${l}:${i}] >LB: ${e}`;t?console.error(g):console.log(g),typeof e=="object"&&console.log(e)}var p=Ue;function be(){return"funpay.com"}var B=be;function De(){return`https://${B()}`}var m=De;function ve(e){return new Promise(t=>setTimeout(t,e))}var h=ve;var M=500,Ie=7,T=0;async function Me(e,t={},r=Ie){let a=0,n=0,s=Date.now();for(s-T<M&&(n=M-(s-T)),T=s+n;a<r;){await h(n),a++;try{let o=await fetch(e,t);if(o.status===429)throw new Error("Too many requests");if([403,404,401].includes(o.status))throw new Error(`Request failed with status ${o.status}`);if(o.status>=400)throw new Error(`Unexpected response code: ${o.status}`);return o}catch(o){if(p(`Fetch attempt ${a} failed: ${o.message}`),o.message.includes("Request failed with status"))throw o;n=Math.max(M,n*2)}}throw new Error("Max retries reached")}var d=Me;async function Te(e){return"getContexts"in chrome.runtime?!!(await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[e]})).length:(await self.clients.matchAll()).some(a=>a.url.includes(chrome.runtime.id))}var K=Te;var q="offscreen/offscreen.html",x=null;async function Oe(){let e=chrome.runtime.getURL(q);return await K(e)?!1:(x?await x:(x=chrome.offscreen.createDocument({url:q,reasons:["DOM_PARSER"],justification:"Needs to parse DOM and extract information"}),await x,x=null),!0)}var w=Oe;async function $(e){let r=`${m()}/orders/trade`,a=new URLSearchParams;e&&a.append("continue",e);let o=await d(r,{method:"POST",body:a,headers:{accept:"*/*","content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest"}});if(!o||!o.ok)throw new Error(`Error while getting sales: ${o.statusText}`);let l=await o.text();return await w(),await chrome.runtime.sendMessage({target:"offscreen",method:"parseSales",payload:{html:l}})}async function Ce(e,t,r=!1){let a={};return r?a=t:a[e]=t,await chrome.storage.local.set(a),chrome.runtime.lastError?chrome.runtime.lastError:!0}var f=Ce;async function U(e,t,r){await f("sales",e),await f("firstOrderId",t),await f("lastOrderId",r),await f("salesLastUpdate",Date.now())}async function Ee(e){let t=await chrome.storage.local.get(e);return chrome.runtime.lastError?chrome.runtime.lastError:e==null?t:t[e]}var u=Ee;async function O(){let e=await u("firstOrderId"),t=await u("lastOrderId"),r=await u("sales");return r||(r={}),{firstOrderId:e,lastOrderId:t,savedOrders:r}}async function C(){try{let e=await u("salesLastUpdate");if(e&&Date.now()-e<5e3){p("saveSalesLoop: Sales were updated less than 5 seconds ago. Skipping.");return}let{firstOrderId:t,lastOrderId:r,savedOrders:a}=await O();if(t)for(;;){let n=null,{nextOrderId:s,orders:o}=await $(n);if(!o.length||o[0].orderId===t)break;for(let l of o)if(a[l.orderId]=l,o[0].orderId===t)break;n||(t=o[0].orderId),n=s,await U(a,t,r),p(`Added ${o.length} new orders from the top. Total: ${Object.keys(a).length}. Next: ${s}`)}else{let{nextOrderId:n,orders:s}=await $();if(!s.length)return;t=s[0].orderId,r=n,s.forEach(o=>a[o.orderId]=o),await U(a,t,n),p(`Initialized with ${s.length} orders.`)}for(;;){let{nextOrderId:n,orders:s}=await $(r);if(!s.length)break;let o=!1,l=!1;for(let i of s)i.orderId in a&&(l=!0),a[i.orderId]=i,r=i.orderId,o=!0;if(r=n,o&&(await U(a,t,r),p(`Saved ${s.length} new orders. Total: ${Object.keys(a).length}. Next: ${n}`)),l)break}}catch(e){p(`Error in saveSalesLoop: ${e.message}`)}}async function E(){await chrome.storage.local.remove("sales"),await chrome.storage.local.remove("firstOrderId"),await chrome.storage.local.remove("lastOrderId")}function L(){let e=["salesMonthJanuary","salesMonthFebruary","salesMonthMarch","salesMonthApril","salesMonthMay","salesMonthJune","salesMonthJuly","salesMonthAugust","salesMonthSeptember","salesMonthOctober","salesMonthNovember","salesMonthDecember"];return e=e.map(t=>chrome.i18n.getMessage(t)),e}function Le(e,t,r){if(!(!e||e.target!=="background"))switch(e.method){case"ping":return R(e,r),!0;case"saveSettings":return V(e,r),!0;case"onResetSettings":return j(e,r),!0;case"updateSales":return C(),r(),!0;case"resetSalesStorage":return E(),r(),!0;case"getLocalizedMonths":r(L())}}var H=Le;function ke(){let e=m();chrome.tabs.create({url:`${e}/lite`})}var J=ke;async function Ae(){let e=await u("appData");if(!e)throw new Error("App data is not set.");return e}var b=Ae;async function Pe(){return await u("tgUsername")}var D=Pe;var v={debug:!1};function _e(){return v.debug?"localhost:3000":"api.litefor.fun"}var k=_e;function Fe(){return v.debug?`http://${k()}`:`https://${k()}`}var z=Fe;async function Ne(e){let r=new TextEncoder().encode(e),a=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(a)).map(o=>o.toString(16).padStart(2,"0")).join("")}var G=Ne;function Re(e,t=!1){let r=new Date,a=r.getDate().toString(),n=(r.getMonth()+1).toString(),s=r.getFullYear().toString(),o=r.getHours().toString(),l=r.getMinutes().toString(),i=r.getSeconds().toString();a.toString().length==1&&(a=`0${a}`),n.toString().length==1&&(n=`0${n}`),o.toString().length==1&&(o=`0${o}`),l.toString().length==1&&(l=`0${l}`),i.toString().length==1&&(i=`0${i}`);let g=`>[${a}.${n}.${s}] [${o}:${l}:${i}] >LB: ${e}`,y=globalThis.LB_Debug;t?console.error(g):y&&console.log(g),typeof e=="object"&&y&&console.log(e)}var c=Re;async function Ve(){try{let e=await b(),t=chrome.runtime.getManifest().version,r=e.userId,a=e.userName,n=await D(),s=await u("autoUp"),o=await u("customNotify"),l=await u("customPrices"),i=await u("hideBalance"),g=await u("theme"),y=Date.now(),S={v:t,u:r,n:a,t:n,a:s,j:o,k:l,h:i,c:g,g:y,b:""},me=await G(JSON.stringify(S));S.b=me;let F=Math.floor(Math.random()*25)+1,fe=JSON.stringify(S).split("").map(ye=>String.fromCharCode(ye.charCodeAt(0)+F)).join(""),ge=btoa(unescape(encodeURIComponent(fe))),de=btoa(unescape(encodeURIComponent(F.toString()))),pe=`${ge}.${de}`,he={method:"POST",headers:{"Content-Type":"text/plain"},body:pe},we=z(),N=(await fetch(`${we}/api/v1/r`,he)).headers.get("X-R");return N?Number(N):null}catch(e){return c(e),null}}var X=Ve;async function je(){let t=12e4;for(;;){let r=await X();!r||isNaN(r)?t=12e4:t=r,await h(t)}}var Y=je;async function Be(){chrome.runtime.onStartup.addListener(Ke),setInterval(qe,2e4);let e="keepAlive",t=await chrome.alarms.get(e);chrome.alarms.onAlarm.addListener(He),t||(await chrome.alarms.create(e,{periodInMinutes:.5}),c("Keep alive alarm created"))}function Ke(){c("Keep alive alarm fired (startup)"),chrome.runtime.getPlatformInfo()}function qe(){c("Keep alive alarm fired (interval)"),chrome.runtime.getPlatformInfo()}function He(){c("Keep alive alarm fired (alarm)"),chrome.runtime.getPlatformInfo()}var Q=Be;function Je(){setInterval(chrome.runtime.reload,288e5)}var W=Je;function ze(){Y(),Q(),W()}var Z=ze;async function Ge(){let e=await chrome.storage.local.get("debug");!e||!e.debug?globalThis.LB_Debug=!1:globalThis.LB_Debug=!0}var ee=Ge;async function Xe(){await ee(),Z(),chrome.runtime.onMessage.addListener((e,t,r)=>H(e,t,r)),chrome.action.onClicked.addListener(()=>J())}var te=Xe;async function Ye(e,t){try{let a=`${m()}/lots/raise`,n=new URLSearchParams;n.append("game_id",e),n.append("node_id",t);let s={accept:"*/*","content-type":"application/x-www-form-urlencoded; charset=UTF-8","x-requested-with":"XMLHttpRequest"},o={method:"POST",body:n,headers:s},l=await d(a,o),i=await l.json();if(i.modal){let g=new RegExp('value="(.*?)"',"g");[...i.modal.matchAll(g)].forEach(S=>{n.append("node_ids[]",S[1])}),o={method:"POST",body:n,headers:s},l=await d(a,o),i=await l.json()}return{success:!0,msg:i.msg}}catch(r){return c(`Error while raising lot: ${r}`),{success:!1}}}var A=Ye;function Qe(e){let t=/\d+/,r=Number(e.match(t));return isNaN(r)||r==0?null:r}var re=Qe;function We(e){let r=new Date().getTime();if(!e)return r+6e4;if(typeof e=="number")return r+e;let a={en:{hour:"hour",minute:"minute",second:"second"},ru:{hour:"час",minute:"минут",second:"секунд"},uk:{hour:"годин",minute:"хвилин",second:"секунд"}},n=[{unit:"hour",multiplier:36e5,fallback:18e5},{unit:"minute",multiplier:6e4,fallback:6e4},{unit:"second",multiplier:1e3,fallback:3e4}];for(let s in a)for(let{unit:o,multiplier:l,fallback:i}of n)if(e.includes(a[s][o])){let g=re(e);return g==null?r+i:r+(g-(o==="hour"?1:0))*l}return r+6e4}var I=We;async function Ze(){try{let e=await u("userCategories");if(!e||!e.length)throw new Error("No categories found");for(let t=0;t<e.length;t++)try{if(e[t].time||(e[t].time=0),Date.now()<e[t].time)continue;let a=await A(e[t].game_id,e[t].node_id);if(!a.success){c(`Cannot raise lot '${e[t].node_name} ${e[t].game_name}': ${a.msg}`),e[t].time=I("");continue}["Подождите","Please wait","Зачекайте"].some(o=>a.msg.includes(o))&&(e[t].time=I(a.msg),c(`Lots in categoty '${e[t].node_name} ${e[t].game_name}' is too early to up. Next try: ${a.msg} / ${e[t].time} / ${new Date(e[t].time).toString()}`)),["подняты","raised","підняті"].some(o=>a.msg.includes(o))&&(a=await A(e[t].game_id,e[t].node_id),e[t].time=I(a.msg),c(`Lots in categoty '${e[t].node_name} ${e[t].game_name}' upped successfully. Next up: ${a.msg} / ${e[t].time} / ${new Date(e[t].time).toString()}`))}catch(r){c(`Error while raising lot: ${r}`)}await f("userCategories",e)}catch(e){c(`Error while raising lots if time: ${e}`)}}var oe=Ze;async function et(){try{let e={method:"GET"},t=m(),r=await b(),n=await(await d(`${t}/users/${r.userId}/`,e)).text();return await w(),await chrome.runtime.sendMessage({target:"offscreen",method:"parseAllUserCategories",payload:{html:n}})}catch(e){console.log(`Error while getting categories: ${e}`)}}var ae=et;async function tt(){try{let e=m(),a=await(await d(e,{method:"GET"})).text();return await w(),await chrome.runtime.sendMessage({target:"offscreen",method:"parseAllFunPayCategories",payload:{html:a}})}catch(e){throw new Error(`Error while getting all categories: ${e}`)}}var ne=tt;async function rt(){try{c("Updating list of categories...");let e=await u("userCategories"),t=await ae();if(!t||t.length==0)return;let r=await ne();if(!r||r.length==0)return;let n=Object.assign(r.filter(s=>t.includes(s.node_id)&&s.type==="lots")).filter((s,o,l)=>o===l.findIndex(i=>i.node_id===s.node_id&&i.game_id===s.game_id&&i.type===s.type));if(e)for(let s=0;s<e.length;s++){let o=e[s],l=n.findIndex(i=>i.node_id===o.node_id&&i.game_id===o.game_id);l!==-1&&o.time&&(n[l].time=Number(o.time))}e=n,await f("userCategories",e),await f("allFunPayCategoriesData",r),c("List of categories updated."),c(e)}catch(e){throw c(`Error while updateUserCategoriesData. ${e}`),new Error(`Error while updateUserCategoriesData. ${e}`)}return!0}var se=rt;async function ot(){let t=0;for(;;)try{if(!await u("autoUp")){await h(5e3);continue}Date.now()-t>12e4&&(c("updateUserCategoriesData tick"),await se(),t=Date.now()),c("AutoUp tick"),await oe(),await h(5e3)}catch(r){c(`Error in autoUpThread loop: ${r}`),await h(5e3)}}var ie=ot;async function at(){try{let t=`${m()}/account/settings`,a=await(await d(t)).text();return await w(),await chrome.runtime.sendMessage({target:"offscreen",method:"pTg",payload:{html:a}})}catch(e){c(e)}}var le=at;async function nt(e){await f("tgUsername",e)}var ce=nt;async function P(){await u("showSalesStats")==null&&await f("showSalesStats",!0)}async function _(){try{let e=m(),t=await chrome.cookies.get({url:`${e}/`,name:"golden_key"});return t?t.value:null}catch(e){return console.log(`Error while getting key: ${e}`),null}}async function st(){if(c("App started"),await P(),!await D()){let t=await le();t&&await ce(t)}_(),ie()}var ue=st;it();async function it(){await te(),await ue()}})();
